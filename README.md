# üõ¥ Flotu Mobility - Sistema de Facturaci√≥n Electr√≥nica

<div align="center">

![Version](https://img.shields.io/badge/version-1.0.0-blue.svg)
![Next.js](https://img.shields.io/badge/Next.js-14.2-black.svg)
![TypeScript](https://img.shields.io/badge/TypeScript-5.0-blue.svg)
![Supabase](https://img.shields.io/badge/Supabase-2.0-green.svg)
![License](https://img.shields.io/badge/license-Proprietary-red.svg)

**Sistema integral de facturaci√≥n electr√≥nica y gesti√≥n de ventas para servicios de movilidad el√©ctrica**

Desarrollado por **Pivvot Consulting** - √Årea de I+D  
Cliente: **Flotu Mobility**

[Caracter√≠sticas](#-caracter√≠sticas-principales) ‚Ä¢
[Instalaci√≥n](#-instalaci√≥n-y-configuraci√≥n) ‚Ä¢
[Arquitectura](#-arquitectura-del-sistema) ‚Ä¢
[Documentaci√≥n](#-documentaci√≥n-t√©cnica)

</div>

---

## üìã Tabla de Contenidos

- [Descripci√≥n General](#-descripci√≥n-general)
- [Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [Stack Tecnol√≥gico](#-stack-tecnol√≥gico)
- [Arquitectura del Sistema](#-arquitectura-del-sistema)
- [Instalaci√≥n y Configuraci√≥n](#-instalaci√≥n-y-configuraci√≥n)
- [Flujos de Usuario](#-flujos-de-usuario)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [Seguridad](#-seguridad-y-cumplimiento)
- [Despliegue](#-despliegue)
- [Documentaci√≥n T√©cnica](#-documentaci√≥n-t√©cnica)
- [Soluci√≥n de Problemas](#-soluci√≥n-de-problemas)
- [Equipo de Desarrollo](#-equipo-de-desarrollo)

---

## üéØ Descripci√≥n General

Sistema empresarial de facturaci√≥n electr√≥nica dise√±ado espec√≠ficamente para **Flotu Mobility**, empresa l√≠der en servicios de movilidad sostenible mediante scooters el√©ctricos. El sistema automatiza completamente el proceso de facturaci√≥n, desde la generaci√≥n de c√≥digos de venta hasta la emisi√≥n de facturas electr√≥nicas validadas por la DIAN.

### Problem√°tica Resuelta

- ‚úÖ **Facturaci√≥n manual** ‚Üí Facturaci√≥n autom√°tica en tiempo real
- ‚úÖ **Desconexi√≥n operador-cliente** ‚Üí Sistema de c√≥digos temporales vinculados
- ‚úÖ **Registro de aceptaciones legales** ‚Üí Cumplimiento normativo autom√°tico
- ‚úÖ **Sin trazabilidad** ‚Üí Dashboard con estad√≠sticas en tiempo real
- ‚úÖ **Procesos dispersos** ‚Üí Integraci√≥n dual Supabase + Siigo

### Impacto Empresarial

- üöÄ **90% reducci√≥n** en tiempo de facturaci√≥n
- üìä **100% trazabilidad** de ventas y operadores
- ‚ö° **Tiempo real** en generaci√≥n de documentos electr√≥nicos
- üîê **Cumplimiento DIAN** autom√°tico
- üì± **Experiencia m√≥vil** optimizada para operadores en campo

---

## ‚ö° Caracter√≠sticas Principales

### üîê Gesti√≥n de Operadores

- **Autenticaci√≥n segura** con Supabase Auth (JWT)
- **Dashboard personalizado** con m√©tricas de rendimiento
- **Generaci√≥n de c√≥digos temporales** (4 d√≠gitos, 30 min validez)
- **Seguimiento en tiempo real** de c√≥digos activos
- **Regeneraci√≥n autom√°tica** tras uso de c√≥digo
- **Estad√≠sticas de ventas** (total, promedio, tendencias)

### üë• Portal de Clientes

- **Formulario p√∫blico** optimizado para m√≥viles
- **Validaci√≥n de c√≥digos** en tiempo real
- **M√∫ltiples m√©todos de pago** (Efectivo, Wompi)
- **Registro de aceptaciones legales** con trazabilidad completa
- **C√°lculo autom√°tico** de servicios y tiempos
- **Interfaz intuitiva** con validaci√≥n en tiempo real

### üìÑ Facturaci√≥n Electr√≥nica

- **Integraci√≥n directa con Siigo** (API v1)
- **Factura electr√≥nica DIAN** con firma digital
- **Env√≠o autom√°tico** al cliente v√≠a email
- **M√∫ltiples productos** configurables
- **IVA calculado** autom√°ticamente
- **Trazabilidad completa** de documentos electr√≥nicos

### üîÑ Sistema de C√≥digos Temporales

- **Generaci√≥n autom√°tica** de c√≥digos √∫nicos
- **Expiraci√≥n configurable** (30 minutos default)
- **Validaci√≥n en dos pasos** (existencia + vigencia)
- **Prevenci√≥n de duplicados** con constraints √∫nicos
- **Marcado autom√°tico** como usado tras venta
- **Regeneraci√≥n inteligente** sin intervenci√≥n manual

---

## üõ†Ô∏è Stack Tecnol√≥gico

### Frontend

| Tecnolog√≠a | Versi√≥n | Uso |
|------------|---------|-----|
| **Next.js** | 14.2.14 | Framework React con App Router y SSR |
| **React** | 18 | Librer√≠a UI con componentes funcionales |
| **TypeScript** | 5.0 | Tipado est√°tico y seguridad en compilaci√≥n |
| **NextUI** | 2.2 | Sistema de componentes UI moderno |
| **TailwindCSS** | 3.4 | Framework CSS utility-first |
| **Framer Motion** | 11.11 | Animaciones y transiciones fluidas |
| **React Hook Form** | - | Gesti√≥n de formularios optimizada |
| **React Hot Toast** | 2.6 | Notificaciones de usuario |
| **Lucide React** | 0.546 | Iconos SVG optimizados |

### Backend & Base de Datos

| Tecnolog√≠a | Versi√≥n | Uso |
|------------|---------|-----|
| **Supabase** | 2.76 | Backend as a Service (BaaS) |
| **PostgreSQL** | 15 | Base de datos relacional |
| **Supabase Auth** | 0.10 | Autenticaci√≥n y sesiones |
| **Row Level Security** | - | Pol√≠ticas de seguridad a nivel de fila |
| **Realtime** | - | Subscripciones en tiempo real |

### Integraciones

| Servicio | Versi√≥n | Uso |
|----------|---------|-----|
| **Siigo API** | v1 | Facturaci√≥n electr√≥nica DIAN |
| **Wompi** | - | Pasarela de pagos online |
| **Axios** | 1.7 | Cliente HTTP para APIs externas |

### DevOps & Deployment

| Herramienta | Versi√≥n | Uso |
|-------------|---------|-----|
| **Docker** | Latest | Containerizaci√≥n de aplicaci√≥n |
| **Docker Compose** | - | Orquestaci√≥n multi-contenedor |
| **Nginx** | Alpine | Reverse proxy y SSL |
| **Node.js** | 20.13.1 | Runtime de JavaScript |

## üöÄ Inicio R√°pido

### 1. Clonar e Instalar

```bash
# Instalar dependencias
npm install
```

---

## üèóÔ∏è Arquitectura del Sistema

### Patr√≥n de Dise√±o: Arquitectura por Capas

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        PRESENTACI√ìN                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ   Operator   ‚îÇ  ‚îÇ    Client    ‚îÇ  ‚îÇ     API      ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ   Dashboard  ‚îÇ  ‚îÇ     Form     ‚îÇ  ‚îÇ   Routes     ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì‚Üë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CONTROLADORES                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ     Auth     ‚îÇ  ‚îÇ   Operator   ‚îÇ  ‚îÇ     Sale     ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  Controller  ‚îÇ  ‚îÇ  Controller  ‚îÇ  ‚îÇ  Controller  ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì‚Üë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        SERVICIOS                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ   Supabase   ‚îÇ  ‚îÇ     Siigo    ‚îÇ  ‚îÇ    Wompi     ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ   Service    ‚îÇ  ‚îÇ   Service    ‚îÇ  ‚îÇ   Service    ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì‚Üë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CAPA DE DATOS                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  PostgreSQL  ‚îÇ  ‚îÇ   Siigo API  ‚îÇ  ‚îÇ   Wompi API  ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  (Supabase)  ‚îÇ  ‚îÇ    (DIAN)    ‚îÇ  ‚îÇ    (Pagos)   ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Datos Principal

```mermaid
sequenceDiagram
    participant O as Operador
    participant D as Dashboard
    participant S as Supabase
    participant C as Cliente
    participant F as Formulario
    participant Si as Siigo

    O->>D: Login
    D->>S: Autenticar
    S-->>D: JWT Token
    D->>S: Generar C√≥digo
    S-->>D: C√≥digo: 6780
    
    C->>F: Ingresar c√≥digo 6780
    F->>S: Validar c√≥digo
    S-->>F: C√≥digo v√°lido
    F->>S: Crear venta
    S-->>F: Venta ID: 123
    F->>Si: Generar factura
    Si-->>F: Factura electr√≥nica
    Si->>C: Enviar factura email
```

### Modelo de Base de Datos

```sql
-- Tabla principal de operadores
operadores (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE,
  nombre TEXT,
  created_at TIMESTAMP
)

-- C√≥digos temporales de venta
operator_codes (
  id SERIAL PRIMARY KEY,
  operator_id UUID ‚Üí operadores.id,
  code TEXT UNIQUE,
  expires_at TIMESTAMP,
  used_at TIMESTAMP NULL,
  venta_id INT ‚Üí ventas.id
)

-- Informaci√≥n de clientes
clientes (
  id SERIAL PRIMARY KEY,
  tipo_documento ENUM('CC', 'Pasaporte', 'NIT'),
  numero_documento TEXT,
  nombre TEXT,
  apellido TEXT,
  correo TEXT,
  direccion TEXT,
  celular TEXT
)

-- Registro de ventas
ventas (
  id SERIAL PRIMARY KEY,
  operador_id UUID ‚Üí operadores.id,
  cliente_id INT ‚Üí clientes.id,
  tiempo_servicio_min INT,
  valor_total NUMERIC,
  created_at TIMESTAMP
)

-- Aceptaciones legales (compliance)
aceptaciones (
  id SERIAL PRIMARY KEY,
  venta_id INT ‚Üí ventas.id,
  acepta_terminos BOOLEAN,
  acepta_privacidad BOOLEAN,
  version_terminos TEXT,
  version_privacidad TEXT,
  ip TEXT,
  user_agent TEXT
)
```

---

## üíª Instalaci√≥n y Configuraci√≥n

### Requisitos Previos

- **Node.js** 20.x (versi√≥n LTS recomendada)
- **npm** 10.x o superior como gestor de paquetes
- **Cuenta de Supabase** (gratuita disponible)
- **Cuenta de Siigo** con acceso a API
- **Git** para control de versiones

### 1. Clonar el Repositorio

```bash
git clone https://github.com/Pivvot-Consulting/billing-form.git
cd billing-form
```

### 2. Instalar Dependencias

```bash
npm install
```

### 3. Configurar Supabase (‚ö†Ô∏è CR√çTICO)

#### 3.1. Crear Proyecto en Supabase

1. Acceder a [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. Crear nuevo proyecto
3. Copiar `URL` y `anon key` del proyecto

#### 3.2. Ejecutar Scripts SQL (EN ORDEN)

**‚ö†Ô∏è IMPORTANTE: Ejecutar en Supabase SQL Editor**

```sql
-- 1. üî¥ OBLIGATORIO - Pol√≠ticas RLS para validaci√≥n de c√≥digos
-- Archivo: scripts/supabase_rls_operator_codes.sql
-- Sin esto, el formulario p√∫blico NO puede validar c√≥digos

-- 2. üü† OBLIGATORIO - Fix ENUM tipo_documento
-- Archivo: scripts/supabase_fix_enum_tipo_documento.sql
-- Agrega valores PP (Pasaporte) y NIT al ENUM

-- 3. üü° RECOMENDADO - Funci√≥n crear_envio_completo
-- Archivo: scripts/supabase_crear_envio_completo.sql
-- Optimiza creaci√≥n de ventas en transacci√≥n √∫nica

-- 4. üü¢ OPCIONAL - Funci√≥n generar_codigo_operador
-- Archivo: scripts/supabase_generar_codigo_operador.sql
-- Mejora rendimiento de generaci√≥n de c√≥digos
```

### 4. Configurar Variables de Entorno

Crear archivo `.env.local` en la ra√≠z del proyecto:

```bash
# ===============================================
# SUPABASE - BACKEND (OBLIGATORIO)
# ===============================================
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu_anon_key_aqui

# ===============================================
# SIIGO - FACTURACI√ìN ELECTR√ìNICA (OBLIGATORIO)
# ===============================================
SIIGO_USER_NAME=usuario@flotu.com
SIIGO_ACCESS_KEY=tu_access_key_de_siigo

# IDs de configuraci√≥n Siigo (Flotu Mobility)
SIIGO_DOCUMENT_ID=28010          # ID documento factura
SIIGO_COST_CENTER_ID=849         # Centro de costos
SIIGO_SELLER_ID=488              # ID vendedor
SIIGO_PAYMENT_ID=4366            # M√©todo de pago

# ===============================================
# WOMPI - PASARELA DE PAGOS (OPCIONAL)
# ===============================================
NEXT_PUBLIC_WOMPI_PAYMENT_URL=https://checkout.wompi.co/p/...

# ===============================================
# GENERAL
# ===============================================
NODE_ENV=development
NEXT_TELEMETRY_DISABLED=1
```

### 5. Ejecutar en Desarrollo

```bash
npm run dev
```

La aplicaci√≥n estar√° disponible en:
- üåê **URL Local**: [http://localhost:3000](http://localhost:3000)
- üë§ **Login Operador**: `/operator/login`
- üìù **Formulario Cliente**: `/cliente/efectivo`

### 6. Build para Producci√≥n

```bash
# Generar build optimizado
npm run build

# Ejecutar en producci√≥n
npm start
```

---

## üë• Flujos de Usuario

### üîµ Flujo de Operador

```
1. Login con credenciales
   ‚Üì
2. Dashboard con c√≥digo activo
   ‚Üì
3. Generar nuevo c√≥digo (si es necesario)
   ‚Üì
4. Compartir c√≥digo con cliente
   ‚Üì
5. Monitorear uso del c√≥digo en tiempo real
   ‚Üì
6. Ver estad√≠sticas de ventas
```

**Rutas del Operador:**
- `/operator/login` - Autenticaci√≥n
- `/operator/dashboard` - Panel principal

### üü¢ Flujo de Cliente

```
1. Acceder al formulario p√∫blico
   ‚Üì
2. Aceptar t√©rminos y condiciones
   ‚Üì
3. Seleccionar m√©todo de pago
   ‚Üì
4. Ingresar c√≥digo del operador
   ‚Üì
5. Completar datos personales
   ‚Üì
6. Configurar tiempo de servicio
   ‚Üì
7. Confirmar y registrar venta
   ‚Üì
8. Recibir factura electr√≥nica por email
```

**Rutas del Cliente:**
- `/` - Selecci√≥n de m√©todo de pago
- `/cliente/efectivo` - Formulario para pago en efectivo
- `/cliente/virtual` - Formulario para pago con Wompi

---

## üìÅ Estructura del Proyecto

```
billing-form/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # P√°gina principal (selecci√≥n rol)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator/                 # M√≥dulo de Operadores (Privado)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/                # Autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/            # Dashboard principal
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cliente/                  # M√≥dulo de Clientes (P√∫blico)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ metodo-pago/          # Selecci√≥n m√©todo pago
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ efectivo/             # Formulario de venta
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ controllers/                  # Capa de Controladores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts        # L√≥gica de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator.controller.ts    # Gesti√≥n de operadores
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sale.controller.ts        # Procesamiento de ventas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                     # Capa de Servicios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase/                 # Servicios Supabase
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts       # Autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator.service.ts   # C√≥digos y operadores
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sales.service.ts      # Gesti√≥n de ventas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SiigoService.ts           # Integraci√≥n Siigo API
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                        # Custom React Hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts                # Hook de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useOperatorCode.ts        # Gesti√≥n de c√≥digos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useOperatorCodeRealtime.ts # Subscripciones realtime
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useSales.ts               # Operaciones de venta
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ types/                        # TypeScript Definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/                      # Data Transfer Objects
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sale.dto.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/                 # Entidades de dominio
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator.types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operatorCode.types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sale.types.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ enums/                    # Enumeraciones
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ constants/                    # Constantes globales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ form.constants.ts         # Validaciones y opciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts                 # Rutas de navegaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.constants.ts     # Configuraci√≥n Supabase
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ components/                   # Componentes UI reutilizables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/                   # Componentes comunes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ErrorBoundary.tsx         # Manejo de errores
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ lib/                          # Configuraci√≥n de librer√≠as
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts               # Cliente Supabase
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ utils/                        # Utilidades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.ts           # Manejo centralizado de errores
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts                 # Middleware de Next.js (Auth)
‚îÇ
‚îú‚îÄ‚îÄ scripts/                          # Scripts SQL y utilidades
‚îÇ   ‚îú‚îÄ‚îÄ supabase_rls_operator_codes.sql        # ‚ö†Ô∏è OBLIGATORIO
‚îÇ   ‚îú‚îÄ‚îÄ supabase_fix_enum_tipo_documento.sql   # ‚ö†Ô∏è OBLIGATORIO
‚îÇ   ‚îú‚îÄ‚îÄ supabase_crear_envio_completo.sql      # Recomendado
‚îÇ   ‚îú‚îÄ‚îÄ supabase_generar_codigo_operador.sql   # Opcional
‚îÇ   ‚îî‚îÄ‚îÄ get-siigo-products.js                  # Utilidad Siigo
‚îÇ
‚îú‚îÄ‚îÄ public/                           # Archivos est√°ticos
‚îú‚îÄ‚îÄ .env.local                        # Variables de entorno (no versionado)
‚îú‚îÄ‚îÄ .env.example                      # Template de variables
‚îú‚îÄ‚îÄ Dockerfile                        # Configuraci√≥n Docker
‚îú‚îÄ‚îÄ docker-compose.yml                # Desarrollo con Docker
‚îú‚îÄ‚îÄ docker-compose.prod.yml           # Producci√≥n con Docker
‚îú‚îÄ‚îÄ nginx.conf                        # Configuraci√≥n Nginx
‚îî‚îÄ‚îÄ package.json                      # Dependencias del proyecto
```

---

## üîê Seguridad y Cumplimiento

### Autenticaci√≥n y Autorizaci√≥n

- **JWT Tokens** con Supabase Auth
- **Row Level Security (RLS)** en todas las tablas
- **Pol√≠ticas de acceso** granulares por rol
- **Sesiones seguras** con refresh tokens autom√°ticos
- **Middleware de protecci√≥n** en rutas privadas

### Protecci√≥n de Datos

```sql
-- Ejemplo de Pol√≠tica RLS
CREATE POLICY "Operadores solo ven sus ventas"
ON ventas FOR SELECT
TO authenticated
USING (operador_id = auth.uid());
```

### Cumplimiento Normativo

- ‚úÖ **GDPR**: Registro de consentimientos con trazabilidad
- ‚úÖ **DIAN**: Facturaci√≥n electr√≥nica validada
- ‚úÖ **Protecci√≥n de datos**: Encriptaci√≥n en tr√°nsito y reposo
- ‚úÖ **Auditor√≠a**: Logs completos de todas las operaciones
- ‚úÖ **T√©rminos y condiciones**: Versioning y tracking de aceptaciones

### Validaciones de Seguridad

- Sanitizaci√≥n de inputs en frontend y backend
- Validaci√≥n de c√≥digos con doble verificaci√≥n (existencia + vigencia)
- Rate limiting en endpoints cr√≠ticos
- CORS configurado espec√≠ficamente para dominios permitidos
- Variables de entorno nunca expuestas al cliente

---

## üöÄ Despliegue

### Opci√≥n 1: Docker (Recomendado)

```bash
# Desarrollo
docker-compose up -d

# Producci√≥n
docker-compose -f docker-compose.prod.yml up -d
```

**Caracter√≠sticas del deployment Docker:**
- ‚úÖ Build optimizado multi-stage
- ‚úÖ Nginx como reverse proxy
- ‚úÖ SSL/TLS configurado
- ‚úÖ Health checks autom√°ticos
- ‚úÖ Resource limits (512MB RAM)
- ‚úÖ Restart autom√°tico en fallos

### Opci√≥n 2: Vercel (Next.js Nativo)

```bash
# Instalar Vercel CLI
npm i -g vercel

# Deploy
vercel --prod
```

**Configuraci√≥n en Vercel:**
1. Conectar repositorio de GitHub
2. Configurar variables de entorno (`.env.local`)
3. Deploy autom√°tico en cada push a `main`

### Opci√≥n 3: VM/VPS Manual

```bash
# 1. Clonar repositorio
git clone https://github.com/Pivvot-Consulting/billing-form.git

# 2. Instalar dependencias
npm install

# 3. Build
npm run build

# 4. Ejecutar con PM2
pm2 start npm --name "billing-form" -- start
pm2 save
pm2 startup
```

### Variables de Entorno en Producci√≥n

Asegurarse de configurar en el servidor:

```bash
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SIIGO_USER_NAME=...
SIIGO_ACCESS_KEY=...
# ... resto de variables
```

---

## üìö Documentaci√≥n T√©cnica

### Documentos Disponibles

- **Scripts SQL**: Configuraci√≥n completa de Supabase
  - `scripts/supabase_rls_operator_codes.sql` - Pol√≠ticas RLS
  - `scripts/supabase_fix_enum_tipo_documento.sql` - Fix ENUM
  - `scripts/supabase_crear_envio_completo.sql` - Funci√≥n RPC ventas
  - `scripts/supabase_generar_codigo_operador.sql` - Funci√≥n RPC c√≥digos

### API Endpoints

#### Supabase RPC Functions

```typescript
// Crear venta completa (transacci√≥n at√≥mica)
POST /rest/v1/rpc/crear_envio_completo
Body: {
  p_operator_code: string,
  p_tipo_documento: 'CC' | 'Pasaporte' | 'NIT',
  p_numero_documento: string,
  p_nombre: string,
  p_apellido: string,
  p_correo: string,
  p_direccion: string,
  p_celular: string,
  p_tiempo_servicio_min: number,
  p_valor_total: number,
  p_acepta_terminos: boolean,
  p_acepta_privacidad: boolean,
  p_version_terminos: string,
  p_version_privacidad: string
}

// Generar c√≥digo de operador
POST /rest/v1/rpc/generar_codigo_operador
Body: {
  p_len: number,      // Longitud del c√≥digo (default: 4)
  p_expira_min: number // Minutos hasta expiraci√≥n (default: 30)
}
```

#### Tablas Supabase

```typescript
// Obtener ventas del operador autenticado
GET /rest/v1/ventas?select=*,clientes(*)&order=created_at.desc

// Obtener c√≥digo activo del operador
GET /rest/v1/operator_codes?select=*&is.used_at=null&gt.expires_at=now()

// Obtener estad√≠sticas
GET /rest/v1/ventas?select=valor_total.sum()
```

---

## üêõ Soluci√≥n de Problemas

### Error: "No se encontr√≥ c√≥digo activo con ese valor"

**S√≠ntoma:** El formulario no valida c√≥digos correctamente

**Causa:** Faltan pol√≠ticas RLS para usuarios an√≥nimos

**Soluci√≥n:**
```bash
# Ejecutar en Supabase SQL Editor
scripts/supabase_rls_operator_codes.sql
```

---

### Error: ENUM tipo_documento inv√°lido

**S√≠ntoma:** `invalid input value for enum tipo_documento: "PP"`

**Causa:** El ENUM no incluye todos los tipos de documento

**Soluci√≥n:**
```bash
# Ejecutar en Supabase SQL Editor
scripts/supabase_fix_enum_tipo_documento.sql
```

---

### Error: Constraint √∫nico violado

**S√≠ntoma:** `duplicate key value violates unique constraint`

**Causa:** C√≥digos expirados no se desactivan correctamente

**Soluci√≥n:** Ya corregido en el c√≥digo. Opcional ejecutar:
```bash
scripts/supabase_generar_codigo_operador.sql
```

---

### Error: Factura no se genera en Siigo

**Verificar:**
1. Credenciales de Siigo en `.env.local`
2. IDs de configuraci√≥n correctos (documento, seller, payment)
3. Logs en consola del servidor

**Soluci√≥n com√∫n:**
```bash
# Verificar variables de entorno
echo $SIIGO_USER_NAME
echo $SIIGO_ACCESS_KEY
```

---

## üë®‚Äçüíª Equipo de Desarrollo

### Pivvot Consulting - √Årea de I+D

**Desarrollado por:**
- √Årea de Investigaci√≥n y Desarrollo
- Pivvot Consulting S.A.S.

**Cliente:**
- Flotu Mobility

**Tecnolog√≠as Core:**
- Next.js 14
- TypeScript 5
- Supabase
- Siigo API

**A√±o:** 2024-2025

**Contacto T√©cnico:**
- üìß Email: [email protected]
- üåê Web: pivvotconsulting.com

---

## üìÑ Licencia y Propiedad Intelectual

```
Copyright ¬© 2024-2025 Pivvot Consulting S.A.S.
Todos los derechos reservados.

Este software es propiedad exclusiva de Pivvot Consulting S.A.S.
y ha sido desarrollado espec√≠ficamente para Flotu Mobility.

Prohibida su reproducci√≥n, distribuci√≥n o modificaci√≥n sin 
autorizaci√≥n expresa por escrito del propietario.
```

---

## üìû Soporte y Mantenimiento

Para soporte t√©cnico, reportar bugs o solicitar nuevas funcionalidades:

1. **Issues en GitHub**: [Repositorio Privado]
2. **Email**: soporte@pivvotconsulting.com
3. **Documentaci√≥n**: Ver carpeta `/docs` (si aplica)

---

<div align="center">

**üõ¥ Desarrollado con ‚ù§Ô∏è por Pivvot Consulting**

*Transformando la movilidad el√©ctrica con tecnolog√≠a de punta*

[Pivvot Consulting](https://pivvotconsulting.com) | [Flotu Mobility](https://flotumobility.com)

</div>
